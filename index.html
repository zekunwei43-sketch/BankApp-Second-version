<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bank CRM Pro</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#15202e',
                            950: '#020617',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #0f172a; /* slate-900 */
            color: #f8fafc; /* slate-50 */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a; 
        }
        ::-webkit-scrollbar-thumb {
            background: #334155; 
            border-radius: 2px;
        }

        .card-enter {
            animation: slideUp 0.3s ease-out forwards;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }

        .completed-task {
            opacity: 0.5;
            filter: grayscale(100%);
        }
        .completed-task h4 {
            text-decoration: line-through;
        }
        
        /* Safe area for bottom nav on newer iPhones */
        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom);
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-slate-900 text-white">

    <!-- Top Navigation -->
    <header class="fixed top-0 left-0 right-0 bg-slate-900/90 backdrop-blur-md border-b border-slate-800 px-4 py-3 flex justify-between items-center z-40 h-14">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-building-columns text-blue-500 text-xl"></i>
            <h1 class="text-lg font-bold tracking-wide">Bank CRM <span class="text-xs font-normal text-slate-400">Pro</span></h1>
        </div>
        <button id="ai-trigger-btn" class="bg-blue-600 hover:bg-blue-500 text-white w-8 h-8 rounded-full flex items-center justify-center shadow-lg shadow-blue-500/20 active:scale-90 transition-transform">
            <i class="fa-solid fa-robot text-sm"></i>
        </button>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-y-auto pt-16 pb-24 px-4 scroll-smooth w-full max-w-lg mx-auto" id="main-container">
        
        <!-- View: Dashboard -->
        <section id="view-dashboard" class="space-y-6 card-enter">
            <!-- Stats Cards -->
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-lg">
                    <p class="text-slate-400 text-xs mb-1 uppercase tracking-wider">æ€»ç®¡ç†èµ„äº§</p>
                    <h2 class="text-xl font-bold text-emerald-400 truncate" id="dash-total-assets">Â¥0</h2>
                </div>
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-lg">
                    <p class="text-slate-400 text-xs mb-1 uppercase tracking-wider">å®¢æˆ·æ€»æ•°</p>
                    <h2 class="text-xl font-bold text-blue-400" id="dash-total-clients">0</h2>
                </div>
            </div>

            <div class="bg-gradient-to-r from-blue-900/30 to-slate-800 p-5 rounded-xl border border-blue-800/30 flex items-center justify-between shadow-lg">
                <div>
                    <h3 class="font-bold text-base text-white">ä»Šæ—¥å¾…åŠ</h3>
                    <p class="text-slate-400 text-xs mt-1" id="dash-reminder-count">æš‚æ— å¾…åŠäº‹é¡¹</p>
                </div>
                <div class="bg-blue-500/20 w-10 h-10 rounded-full flex items-center justify-center">
                    <i class="fa-regular fa-bell text-blue-400 text-lg"></i>
                </div>
            </div>

            <!-- Quick Actions -->
            <div>
                <h3 class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-3">å¿«æ·æ“ä½œ</h3>
                <div class="grid grid-cols-4 gap-3">
                    <button onclick="app.modals.openClient()" class="flex flex-col items-center gap-2 p-3 bg-slate-800 rounded-xl border border-slate-700 active:bg-slate-700 transition-colors">
                        <div class="w-10 h-10 rounded-full bg-blue-500/10 flex items-center justify-center text-blue-400"><i class="fa-solid fa-user-plus"></i></div>
                        <span class="text-[10px] text-slate-300">åŠ å®¢æˆ·</span>
                    </button>
                    <button onclick="app.modals.openReminder()" class="flex flex-col items-center gap-2 p-3 bg-slate-800 rounded-xl border border-slate-700 active:bg-slate-700 transition-colors">
                        <div class="w-10 h-10 rounded-full bg-amber-500/10 flex items-center justify-center text-amber-400"><i class="fa-solid fa-clock"></i></div>
                        <span class="text-[10px] text-slate-300">åŠ æé†’</span>
                    </button>
                    <button onclick="app.speech.start()" class="flex flex-col items-center gap-2 p-3 bg-slate-800 rounded-xl border border-slate-700 active:bg-slate-700 transition-colors">
                        <div class="w-10 h-10 rounded-full bg-purple-500/10 flex items-center justify-center text-purple-400"><i class="fa-solid fa-microphone"></i></div>
                        <span class="text-[10px] text-slate-300">è¯­éŸ³</span>
                    </button>
                    <button onclick="app.nav.to('settings')" class="flex flex-col items-center gap-2 p-3 bg-slate-800 rounded-xl border border-slate-700 active:bg-slate-700 transition-colors">
                        <div class="w-10 h-10 rounded-full bg-slate-700/50 flex items-center justify-center text-slate-400"><i class="fa-solid fa-gear"></i></div>
                        <span class="text-[10px] text-slate-300">è®¾ç½®</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- View: Clients -->
        <section id="view-clients" class="hidden space-y-4">
            <div class="flex justify-between items-center mb-1">
                <h2 class="text-lg font-bold">å®¢æˆ·åˆ—è¡¨</h2>
                <button onclick="app.modals.openClient()" class="bg-blue-600 text-white text-xs font-bold px-3 py-1.5 rounded-lg hover:bg-blue-500 shadow-md active:scale-95 transition-transform">+ æ–°å¢</button>
            </div>
            
            <!-- Search & Filter Toolbar -->
            <div class="bg-slate-800 p-3 rounded-xl border border-slate-700 mb-2 space-y-3">
                <!-- Row 1: Search -->
                <div class="relative">
                    <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm"></i>
                    <input type="text" id="client-search" oninput="app.render.clients()" placeholder="ğŸ” æœç´¢å®¢æˆ·å§“åæˆ–å…¬å¸..." 
                        class="w-full bg-slate-900 border border-slate-700 rounded-lg pl-9 pr-4 py-2.5 text-sm text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                </div>
                <!-- Row 2: Filter & Sort -->
                <div class="flex gap-3">
                    <div class="w-1/2 relative">
                         <i class="fa-solid fa-filter absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                        <select id="client-filter" onchange="app.render.clients()" class="w-full bg-slate-900 border border-slate-700 rounded-lg pl-8 pr-2 py-2.5 text-xs text-white appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="0">å…¨éƒ¨å®¢æˆ·</option>
                            <option value="1000000">èµ„é‡‘ > 100ä¸‡</option>
                            <option value="5000000">èµ„é‡‘ > 500ä¸‡</option>
                            <option value="10000000">èµ„é‡‘ > 1000ä¸‡</option>
                        </select>
                        <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 text-xs pointer-events-none"></i>
                    </div>
                    <div class="w-1/2 relative">
                        <i class="fa-solid fa-arrow-down-wide-short absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                        <select id="client-sort" onchange="app.render.clients()" class="w-full bg-slate-900 border border-slate-700 rounded-lg pl-8 pr-2 py-2.5 text-xs text-white appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="default">é»˜è®¤æ’åº</option>
                            <option value="high">èµ„é‡‘ (ä»é«˜åˆ°ä½)</option>
                            <option value="low">èµ„é‡‘ (ä»ä½åˆ°é«˜)</option>
                        </select>
                        <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 text-xs pointer-events-none"></i>
                    </div>
                </div>
            </div>

            <div id="client-list" class="space-y-3">
                <!-- Client Cards Injected Here -->
            </div>
        </section>

        <!-- View: Reminders -->
        <section id="view-reminders" class="hidden space-y-4">
            <div class="flex flex-col gap-3 mb-2">
                <div class="flex justify-between items-center">
                    <h2 class="text-lg font-bold">ä¸šåŠ¡æé†’</h2>
                    <button onclick="app.modals.openReminder()" class="bg-blue-600 text-white text-xs font-bold px-3 py-1.5 rounded-lg hover:bg-blue-500 shadow-md active:scale-95 transition-transform">+ æ–°å¢</button>
                </div>
                <!-- Search Bar -->
                <div class="relative">
                    <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm"></i>
                    <input type="text" id="reminder-search-input" oninput="app.render.reminders()" placeholder="æœç´¢ä¸šåŠ¡å†…å®¹..." 
                        class="w-full bg-slate-800 border border-slate-700 rounded-lg pl-10 pr-4 py-3 text-sm text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                </div>
            </div>

            <div id="reminder-list" class="space-y-3">
                <!-- Reminder Cards Injected Here -->
            </div>
        </section>

        <!-- View: Settings -->
        <section id="view-settings" class="hidden space-y-6">
            <h2 class="text-lg font-bold mb-4">ç³»ç»Ÿè®¾ç½®</h2>
            
            <div class="bg-slate-800 rounded-xl border border-slate-700 p-5 space-y-4 shadow-lg">
                <h3 class="font-bold text-blue-400 flex items-center gap-2 text-sm">
                    <i class="fa-solid fa-brain"></i> AI é…ç½® (DeepSeek)
                </h3>
                
                <div>
                    <label class="block text-xs text-slate-400 mb-1">DeepSeek API Key</label>
                    <input type="password" id="setting-api-key" placeholder="Paste your DeepSeek Key here (sk-...)" 
                        class="w-full bg-slate-700 text-white border border-slate-600 rounded-lg p-3 mt-1 focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-all">
                </div>
                <button onclick="app.settings.save()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-lg text-sm font-bold shadow-lg shadow-blue-600/20 active:scale-95 transition-all">
                    ä¿å­˜é…ç½®
                </button>
            </div>

            <div class="bg-slate-800 rounded-xl border border-slate-700 p-5 space-y-4 shadow-lg">
                <h3 class="font-bold text-slate-200 text-sm">æ•°æ®ç®¡ç†</h3>
                <button onclick="app.data.seed()" class="w-full bg-slate-700 hover:bg-slate-600 text-slate-200 py-3 rounded-lg text-sm font-medium transition-colors border border-slate-600">
                    é‡ç½®å¹¶å¡«å…¥æµ‹è¯•æ•°æ®
                </button>
                <button onclick="localStorage.clear(); window.location.reload()" class="w-full bg-red-900/20 hover:bg-red-900/30 text-red-400 py-3 rounded-lg text-sm font-medium transition-colors border border-red-900/30">
                    æ¸…é™¤æ‰€æœ‰æ•°æ®
                </button>
            </div>
        </section>

    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-slate-900 border-t border-slate-800 z-50 pb-safe">
        <div class="flex justify-around items-center h-16">
            <button onclick="app.nav.to('dashboard')" class="nav-btn active flex flex-col items-center gap-1 w-full h-full justify-center text-blue-500" data-target="dashboard">
                <i class="fa-solid fa-chart-pie text-lg"></i>
                <span class="text-[10px] font-medium">æ¦‚è§ˆ</span>
            </button>
            <button onclick="app.nav.to('clients')" class="nav-btn flex flex-col items-center gap-1 w-full h-full justify-center text-slate-500 hover:text-slate-300" data-target="clients">
                <i class="fa-solid fa-users text-lg"></i>
                <span class="text-[10px] font-medium">å®¢æˆ·</span>
            </button>
            <button onclick="app.nav.to('reminders')" class="nav-btn flex flex-col items-center gap-1 w-full h-full justify-center text-slate-500 hover:text-slate-300" data-target="reminders">
                <i class="fa-solid fa-list-check text-lg"></i>
                <span class="text-[10px] font-medium">æé†’</span>
            </button>
            <button onclick="app.nav.to('settings')" class="nav-btn flex flex-col items-center gap-1 w-full h-full justify-center text-slate-500 hover:text-slate-300" data-target="settings">
                <i class="fa-solid fa-gear text-lg"></i>
                <span class="text-[10px] font-medium">è®¾ç½®</span>
            </button>
        </div>
    </nav>

    <!-- Modal: Urgent Alert (App Launch) -->
    <div id="modal-urgent" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4" onclick="if(event.target === this) document.getElementById('modal-urgent').classList.add('hidden')">
        <div class="bg-slate-800 w-full max-w-sm rounded-xl border border-red-500/50 shadow-2xl shadow-red-900/30 overflow-hidden animate-[slideUp_0.4s_ease-out]">
            <div class="bg-red-900/20 p-4 border-b border-red-900/50 flex items-center gap-3">
                <i class="fa-solid fa-triangle-exclamation text-red-500 text-xl"></i>
                <h3 class="font-bold text-red-100 text-lg">ç´§æ€¥ä¸šåŠ¡æé†’</h3>
            </div>
            <div class="p-5 max-h-[50vh] overflow-y-auto space-y-3" id="urgent-list-container">
                <!-- Urgent Items injected here -->
            </div>
            <div class="p-4 bg-slate-800 border-t border-slate-700">
                <button onclick="document.getElementById('modal-urgent').classList.add('hidden')" class="w-full py-3 bg-red-600 hover:bg-red-500 text-white rounded-lg font-bold text-sm shadow-lg shadow-red-600/20 transition-all active:scale-95">
                    æˆ‘çŸ¥é“äº†
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Client Edit/Add -->
    <div id="modal-client" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4" onclick="if(event.target === this) app.modals.close('client')">
        <div class="bg-slate-800 w-full max-w-sm rounded-xl shadow-2xl border border-slate-700 flex flex-col max-h-[85vh] animate-[slideUp_0.3s_ease-out]">
            <div class="px-5 py-4 border-b border-slate-700 flex justify-between items-center">
                <h3 class="text-lg font-bold text-white" id="modal-client-title">ç¼–è¾‘å®¢æˆ·</h3>
                <button onclick="app.modals.close('client')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-slate-400 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-5 overflow-y-auto custom-scrollbar">
                <input type="hidden" id="client-id">
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1 ml-1">å§“å <span class="text-red-400">*</span></label>
                        <input type="text" id="client-name" class="w-full bg-slate-700 text-white border border-slate-600 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-all">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1 ml-1">èŒä½</label>
                        <input type="text" id="client-role" class="w-full bg-slate-700 text-white border border-slate-600 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-all">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="block text-xs text-slate-400 mb-1 ml-1">å…¬å¸åç§°</label>
                    <input type="text" id="client-company" class="w-full bg-slate-700 text-white border border-slate-600 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-all">
                </div>
                <div class="mb-3">
                    <label class="block text-xs text-slate-400 mb-1 ml-1">èº«ä»½è¯å·</label>
                    <input type="text" id="client-idcard" class="w-full bg-slate-700 text-white border border-slate-600 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-all">
                </div>
                <div class="mb-3">
                    <label class="block text-xs text-slate-400 mb-1 ml-1">èµ„é‡‘èµ„äº§ (Â¥)</label>
                    <input type="number" id="client-assets" class="w-full bg-slate-700 text-white border border-slate-600 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-all">
                </div>
                <div class="mb-3">
                    <label class="block text-xs text-slate-400 mb-1 ml-1">å–œå¥½</label>
                    <input type="text" id="client-hobbies" class="w-full bg-slate-700 text-white border border-slate-600 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-all">
                </div>
                <div class="mb-3">
                    <label class="block text-xs text-slate-400 mb-1 ml-1">å¤‡æ³¨</label>
                    <textarea id="client-remarks" rows="3" class="w-full bg-slate-700 text-white border border-slate-600 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-all"></textarea>
                </div>
            </div>
            <div class="p-4 border-t border-slate-700 flex gap-3 bg-slate-800 rounded-b-xl">
                <button type="button" id="btn-delete-client" class="hidden px-4 py-2.5 bg-red-900/20 text-red-400 rounded-lg text-sm font-medium border border-red-900/50 hover:bg-red-900/40">åˆ é™¤</button>
                <div class="flex-1"></div>
                <button type="button" onclick="app.modals.close('client')" class="px-5 py-2.5 text-slate-300 text-sm font-medium hover:text-white">å–æ¶ˆ</button>
                <button type="button" onclick="app.data.saveClientFromModal()" class="px-6 py-2.5 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm font-bold shadow-lg shadow-blue-600/20 active:scale-95 transition-all">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- Modal: Reminder Edit/Add -->
    <div id="modal-reminder" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4" onclick="if(event.target === this) app.modals.close('reminder')">
        <div class="bg-slate-800 w-full max-w-sm rounded-xl shadow-2xl border border-slate-700 flex flex-col max-h-[85vh] animate-[slideUp_0.3s_ease-out]">
            <div class="px-5 py-4 border-b border-slate-700 flex justify-between items-center">
                <h3 class="text-lg font-bold text-white" id="modal-reminder-title">æ–°å¢æé†’</h3>
                <button onclick="app.modals.close('reminder')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-slate-400 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-5 space-y-3">
                <input type="hidden" id="reminder-id">
                <div>
                    <label class="block text-xs text-slate-400 mb-1 ml-1">äº‹é¡¹æè¿° <span class="text-red-400">*</span></label>
                    <input type="text" id="reminder-desc" class="w-full bg-slate-700 text-white border border-slate-600 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-all">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1 ml-1">æ—¥æœŸ</label>
                        <input type="date" id="reminder-date" class="w-full bg-slate-700 text-white border border-slate-600 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-all [color-scheme:dark]">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1 ml-1">é‡‘é¢ (CNY)</label>
                        <input type="number" id="reminder-amount" class="w-full bg-slate-700 text-white border border-slate-600 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-all">
                    </div>
                </div>
                <div>
                    <label class="block text-xs text-slate-400 mb-1 ml-1">ç±»å‹</label>
                    <select id="reminder-type" class="w-full bg-slate-700 text-white border border-slate-600 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-all appearance-none">
                        <option value="business">ä¸šåŠ¡åŠç†</option>
                        <option value="meeting">å®¢æˆ·ä¼šè®®</option>
                        <option value="call">ç”µè¯å›è®¿</option>
                        <option value="other">å…¶ä»–äº‹é¡¹</option>
                    </select>
                </div>
            </div>
            <div class="p-4 border-t border-slate-700 flex gap-3 bg-slate-800 rounded-b-xl">
                <button type="button" id="btn-delete-reminder" class="hidden px-4 py-2.5 bg-red-900/20 text-red-400 rounded-lg text-sm font-medium border border-red-900/50 hover:bg-red-900/40">åˆ é™¤</button>
                <div class="flex-1"></div>
                <button type="button" onclick="app.modals.close('reminder')" class="px-5 py-2.5 text-slate-300 text-sm font-medium hover:text-white">å–æ¶ˆ</button>
                <button type="button" onclick="app.data.saveReminderFromModal()" class="px-6 py-2.5 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm font-bold shadow-lg shadow-blue-600/20 active:scale-95 transition-all">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- Modal: AI Assistant -->
    <div id="modal-ai" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4" onclick="if(event.target === this) app.modals.close('ai')">
        <div class="bg-slate-800 w-full max-w-sm rounded-2xl shadow-2xl border border-slate-700 p-6 flex flex-col animate-[slideUp_0.3s_ease-out]">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 flex items-center justify-center shadow-lg shadow-purple-500/30">
                        <i class="fa-solid fa-sparkles text-white text-xs"></i>
                    </div>
                    <h3 class="font-bold text-lg text-white">AI åŠ©æ‰‹</h3>
                </div>
                <button onclick="app.modals.close('ai')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-slate-400 hover:text-white transition-colors"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <div class="bg-slate-900 rounded-xl p-4 border border-slate-700 mb-5 shadow-inner">
                <textarea id="ai-input-text" rows="3" placeholder="è¯·è¯´è¯æˆ–è¾“å…¥... (ä¾‹å¦‚: åˆ é™¤å®¢æˆ·ç‹å»ºå›½)" class="w-full bg-transparent text-white text-sm focus:outline-none resize-none placeholder-slate-600 leading-relaxed"></textarea>
            </div>

            <div class="flex items-center justify-between">
                <button id="btn-mic" onmousedown="app.speech.startRec()" onmouseup="app.speech.stopRec()" ontouchstart="app.speech.startRec()" ontouchend="app.speech.stopRec()" 
                    class="flex items-center gap-2 px-5 py-2.5 rounded-full bg-slate-700 border border-slate-600 text-slate-300 active:bg-blue-900/50 active:border-blue-500 active:text-blue-400 transition-all select-none">
                    <i class="fa-solid fa-microphone"></i>
                    <span class="text-xs font-bold" id="mic-status">æŒ‰ä½è¯´è¯</span>
                </button>
                
                <button onclick="app.ai.process()" id="btn-ai-send" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2.5 rounded-full text-sm font-bold shadow-lg shadow-blue-600/20 flex items-center gap-2 active:scale-95 transition-all">
                    <span>å‘é€æŒ‡ä»¤</span>
                    <i class="fa-solid fa-paper-plane text-xs"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 bg-slate-800 border border-slate-600 text-white px-5 py-3 rounded-full shadow-2xl flex items-center gap-3 transition-all duration-300 opacity-0 translate-y-[-20px] pointer-events-none z-[100] whitespace-nowrap">
        <i class="fa-solid fa-circle-check text-green-400 text-lg" id="toast-icon"></i>
        <span class="text-sm font-bold" id="toast-message">Operation Successful</span>
    </div>

    <!-- Application Logic -->
    <script>
        const app = {
            state: {
                clients: [],
                reminders: [],
                settings: {
                    apiKey: ''
                }
            },

            init() {
                this.data.load();
                this.utils.checkUrgentAlert();
                this.render.all();
                this.events.setup();
                
                // Initialize default view
                this.nav.to('dashboard');
            },

            events: {
                setup() {
                    document.getElementById('ai-trigger-btn').addEventListener('click', () => app.modals.open('ai'));
                    
                    // Close modals on Esc
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape') {
                            app.modals.close('client');
                            app.modals.close('reminder');
                            app.modals.close('ai');
                            document.getElementById('modal-urgent').classList.add('hidden');
                        }
                    });
                }
            },

            data: {
                load() {
                    const c = localStorage.getItem('bank_clients');
                    const r = localStorage.getItem('bank_reminders');
                    const s = localStorage.getItem('bank_settings');
                    
                    if (c) app.state.clients = JSON.parse(c);
                    if (r) app.state.reminders = JSON.parse(r);
                    if (s) {
                        app.state.settings = JSON.parse(s);
                        document.getElementById('setting-api-key').value = app.state.settings.apiKey || '';
                    }
                },
                
                save() {
                    localStorage.setItem('bank_clients', JSON.stringify(app.state.clients));
                    localStorage.setItem('bank_reminders', JSON.stringify(app.state.reminders));
                    app.render.all();
                },

                seed() {
                    app.state.clients = [
                        { id: 1, name: "ç‹å»ºå›½", company: "å»ºå›½ç‰©æµé›†å›¢", role: "è‘£äº‹é•¿", idcard: "110101197001011234", assets: 50000000, hobbies: "é«˜å°”å¤«, èŒ¶é“", remarks: "VIPå®¢æˆ·ï¼Œå–œæ¬¢å–æ™®æ´±" },
                        { id: 2, name: "æç´ èŠ¬", company: "ç¾å¥½é¤é¥®è¿é”", role: "æ€»ç»ç†", idcard: "310101198205055678", assets: 8500000, hobbies: "æ—…æ¸¸", remarks: "æœ‰æ„å‘åšå®¶æ—ä¿¡æ‰˜" },
                        { id: 3, name: "å¼ ä¼Ÿ", company: "æœªæ¥ç§‘æŠ€", role: "CTO", idcard: "440101199012129999", assets: 12000000, hobbies: "æ»‘é›ª, ç¼–ç¨‹", remarks: "å¹´è½»æ–°è´µï¼Œå…³æ³¨ç§‘æŠ€è‚¡" }
                    ];
                    // Create some urgent and non-urgent data
                    const today = new Date().toISOString().split('T')[0];
                    const tomorrow = new Date(Date.now() + 86400000).toISOString().split('T')[0];
                    
                    app.state.reminders = [
                        { id: 1, desc: "ç‹æ€» - å¤§é¢å­˜å•åˆ°æœŸç¡®è®¤", date: today, amount: 5000000, type: "business", status: "pending" },
                        { id: 2, desc: "ææ€» - å®¶æ—ä¿¡æ‰˜æ–¹æ¡ˆæ²Ÿé€šä¼š", date: tomorrow, amount: 0, type: "meeting", status: "pending" },
                        { id: 3, desc: "å¼ ä¼Ÿ - ç§‘æŠ€è‚¡æŠ•èµ„å»ºè®®ä¹¦", date: "2023-12-01", amount: 200000, type: "other", status: "completed" }
                    ];
                    this.save();
                    app.utils.toast('æµ‹è¯•æ•°æ®å·²å¯¼å…¥');
                },

                addClient(data) {
                    const newClient = { id: Date.now(), ...data };
                    app.state.clients.unshift(newClient);
                    app.data.save();
                    return newClient;
                },

                updateClient(id, data) {
                    const idx = app.state.clients.findIndex(c => c.id == id);
                    if (idx > -1) {
                        app.state.clients[idx] = { ...app.state.clients[idx], ...data };
                        app.data.save();
                    }
                },

                deleteClient(id) {
                    app.state.clients = app.state.clients.filter(c => c.id != id);
                    app.data.save();
                },

                saveClientFromModal() {
                    const id = document.getElementById('client-id').value;
                    const data = {
                        name: document.getElementById('client-name').value,
                        company: document.getElementById('client-company').value,
                        role: document.getElementById('client-role').value,
                        idcard: document.getElementById('client-idcard').value,
                        assets: parseFloat(document.getElementById('client-assets').value) || 0,
                        hobbies: document.getElementById('client-hobbies').value,
                        remarks: document.getElementById('client-remarks').value
                    };

                    if(!data.name) return app.utils.toast('è¯·è¾“å…¥å§“å', 'error');

                    if (id) {
                        app.data.updateClient(id, data);
                        app.utils.toast('å®¢æˆ·ä¿¡æ¯å·²æ›´æ–°');
                    } else {
                        app.data.addClient(data);
                        app.utils.toast('æ–°å®¢æˆ·å·²æ·»åŠ ');
                    }
                    app.modals.close('client');
                },

                addReminder(data) {
                    // Force default status
                    const newReminder = { id: Date.now(), status: 'pending', ...data };
                    app.state.reminders.unshift(newReminder);
                    app.data.save();
                    return newReminder;
                },

                updateReminder(id, data) {
                    const idx = app.state.reminders.findIndex(r => r.id == id);
                    if (idx > -1) {
                        app.state.reminders[idx] = { ...app.state.reminders[idx], ...data };
                        app.data.save();
                    }
                },

                toggleReminderStatus(id) {
                    const idx = app.state.reminders.findIndex(r => r.id == id);
                    if (idx > -1) {
                        const current = app.state.reminders[idx];
                        current.status = current.status === 'completed' ? 'pending' : 'completed';
                        app.data.save();
                        app.utils.toast(current.status === 'completed' ? 'å·²æ ‡è®°ä¸ºå®Œæˆ' : 'å·²æ¢å¤ä¸ºå¾…åŠ');
                    }
                },

                deleteReminder(id) {
                    app.state.reminders = app.state.reminders.filter(r => r.id != id);
                    app.data.save();
                },

                saveReminderFromModal() {
                    const id = document.getElementById('reminder-id').value;
                    const data = {
                        desc: document.getElementById('reminder-desc').value,
                        date: document.getElementById('reminder-date').value,
                        amount: parseFloat(document.getElementById('reminder-amount').value) || 0,
                        type: document.getElementById('reminder-type').value,
                        // Preserve existing status if updating, else pending
                    };

                    if(!data.desc) return app.utils.toast('è¯·è¾“å…¥æè¿°', 'error');

                    if (id) {
                        // Preserve status
                        const existing = app.state.reminders.find(r => r.id == id);
                        if(existing) data.status = existing.status;
                        app.data.updateReminder(id, data);
                        app.utils.toast('æé†’å·²æ›´æ–°');
                    } else {
                        data.status = 'pending';
                        app.data.addReminder(data);
                        app.utils.toast('æ–°æé†’å·²æ·»åŠ ');
                    }
                    app.modals.close('reminder');
                }
            },

            nav: {
                to(viewId) {
                    // Update content visibility
                    document.querySelectorAll('main > section').forEach(el => el.classList.add('hidden'));
                    const target = document.getElementById(`view-${viewId}`);
                    target.classList.remove('hidden');
                    if(target.classList.contains('card-enter')) {
                        // Re-trigger animation
                        target.classList.remove('card-enter');
                        void target.offsetWidth; 
                        target.classList.add('card-enter');
                    }

                    // Update nav buttons
                    document.querySelectorAll('.nav-btn').forEach(btn => {
                        if (btn.dataset.target === viewId) {
                            btn.classList.add('text-blue-500');
                            btn.classList.remove('text-slate-500');
                        } else {
                            btn.classList.remove('text-blue-500');
                            btn.classList.add('text-slate-500');
                        }
                    });
                }
            },

            modals: {
                open(name) {
                    document.getElementById(`modal-${name}`).classList.remove('hidden');
                },
                close(name) {
                    document.getElementById(`modal-${name}`).classList.add('hidden');
                },
                openClient(id = null) {
                    const modalTitle = document.getElementById('modal-client-title');
                    const btnDel = document.getElementById('btn-delete-client');
                    
                    if (id) {
                        const client = app.state.clients.find(c => c.id == id);
                        if (!client) return;
                        
                        modalTitle.innerText = 'ç¼–è¾‘å®¢æˆ·';
                        document.getElementById('client-id').value = client.id;
                        document.getElementById('client-name').value = client.name || '';
                        document.getElementById('client-company').value = client.company || '';
                        document.getElementById('client-role').value = client.role || '';
                        document.getElementById('client-idcard').value = client.idcard || '';
                        document.getElementById('client-assets').value = client.assets || '';
                        document.getElementById('client-hobbies').value = client.hobbies || '';
                        document.getElementById('client-remarks').value = client.remarks || '';
                        
                        btnDel.classList.remove('hidden');
                        btnDel.onclick = () => {
                            if(confirm('ç¡®å®šåˆ é™¤è¯¥å®¢æˆ·å—ï¼Ÿ')) {
                                app.data.deleteClient(id);
                                app.modals.close('client');
                                app.utils.toast('å®¢æˆ·å·²åˆ é™¤');
                            }
                        };
                    } else {
                        modalTitle.innerText = 'æ–°å¢å®¢æˆ·';
                        document.getElementById('client-id').value = '';
                        document.querySelectorAll('#modal-client input:not([type=hidden]), #modal-client textarea').forEach(i => i.value = '');
                        btnDel.classList.add('hidden');
                    }
                    this.open('client');
                },
                openReminder(id = null) {
                    const modalTitle = document.getElementById('modal-reminder-title');
                    const btnDel = document.getElementById('btn-delete-reminder');
                    
                    if (id) {
                        const rem = app.state.reminders.find(r => r.id == id);
                        if (!rem) return;
                        
                        modalTitle.innerText = 'ç¼–è¾‘æé†’';
                        document.getElementById('reminder-id').value = rem.id;
                        document.getElementById('reminder-desc').value = rem.desc || '';
                        document.getElementById('reminder-date').value = rem.date || '';
                        document.getElementById('reminder-amount').value = rem.amount || '';
                        document.getElementById('reminder-type').value = rem.type || 'business';

                        btnDel.classList.remove('hidden');
                        btnDel.onclick = () => {
                            if(confirm('ç¡®å®šåˆ é™¤è¯¥æé†’å—ï¼Ÿ')) {
                                app.data.deleteReminder(id);
                                app.modals.close('reminder');
                                app.utils.toast('æé†’å·²åˆ é™¤');
                            }
                        };
                    } else {
                        modalTitle.innerText = 'æ–°å¢æé†’';
                        document.getElementById('reminder-id').value = '';
                        document.querySelectorAll('#modal-reminder input:not([type=hidden])').forEach(i => i.value = '');
                        // Default date to today
                        document.getElementById('reminder-date').valueAsDate = new Date();
                        btnDel.classList.add('hidden');
                    }
                    this.open('reminder');
                }
            },

            render: {
                all() {
                    this.dashboard();
                    this.clients();
                    this.reminders();
                },
                dashboard() {
                    const totalAssets = app.state.clients.reduce((sum, c) => sum + (Number(c.assets) || 0), 0);
                    document.getElementById('dash-total-assets').innerText = app.utils.formatCurrency(totalAssets);
                    document.getElementById('dash-total-clients').innerText = app.state.clients.length;
                    
                    const today = new Date().toISOString().split('T')[0];
                    const todayReminders = app.state.reminders.filter(r => r.date === today && r.status !== 'completed').length;
                    document.getElementById('dash-reminder-count').innerText = todayReminders > 0 ? `ä»Šå¤©æœ‰ ${todayReminders} é¡¹å¾…åŠ` : 'ä»Šå¤©æš‚æ— å¾…åŠäº‹é¡¹';
                },
                clients() {
                    const list = document.getElementById('client-list');
                    // Get Search, Filter, Sort Values (Handle optional inputs)
                    const searchTerm = document.getElementById('client-search')?.value.toLowerCase() || '';
                    const filterAsset = parseFloat(document.getElementById('client-filter')?.value || 0);
                    const sortType = document.getElementById('client-sort')?.value || 'default';

                    list.innerHTML = '';
                    
                    // 1. Filter
                    let items = app.state.clients.filter(c => {
                        const matchText = (c.name && c.name.toLowerCase().includes(searchTerm)) || 
                                          (c.company && c.company.toLowerCase().includes(searchTerm));
                        const matchAsset = (Number(c.assets) || 0) >= filterAsset;
                        return matchText && matchAsset;
                    });

                    // 2. Sort
                    if (sortType === 'high') {
                        items.sort((a, b) => (Number(b.assets) || 0) - (Number(a.assets) || 0));
                    } else if (sortType === 'low') {
                        items.sort((a, b) => (Number(a.assets) || 0) - (Number(b.assets) || 0));
                    } else {
                        // Default: Newest first (based on ID timestamp)
                         items.sort((a, b) => b.id - a.id);
                    }

                    // 3. Render
                    items.forEach(c => {
                        const div = document.createElement('div');
                        div.className = 'bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-lg active:bg-slate-700 transition-colors cursor-pointer relative mb-3';
                        div.onclick = () => app.modals.openClient(c.id);
                        div.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <h3 class="font-bold text-lg text-white">${c.name}</h3>
                                        ${c.role ? `<span class="bg-blue-900/40 text-blue-400 text-[10px] font-bold px-2 py-0.5 rounded border border-blue-500/30">${c.role}</span>` : ''}
                                    </div>
                                    <p class="text-slate-400 text-sm font-medium">${c.company || 'æœªå¡«å†™å…¬å¸ä¿¡æ¯'}</p>
                                </div>
                                <div class="flex flex-col items-end gap-3">
                                    <p class="text-emerald-400 font-bold text-base">${app.utils.formatCurrency(c.assets)}</p>
                                    <button onclick="event.stopPropagation(); window.deleteClient(${c.id})" class="text-slate-500 hover:text-red-400 p-2 -mr-2 active:scale-110 transition-transform">
                                        <i class="fa-solid fa-trash-can text-lg"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                        list.appendChild(div);
                    });
                    if (items.length === 0) list.innerHTML = `<div class="text-center text-slate-500 py-10">æš‚æ— ç¬¦åˆæ¡ä»¶çš„å®¢æˆ·</div>`;
                },
                reminders() {
                    const list = document.getElementById('reminder-list');
                    const search = document.getElementById('reminder-search-input').value.toLowerCase();
                    list.innerHTML = '';
                    
                    // Filter
                    let items = app.state.reminders.filter(r => 
                        !search || (r.desc && r.desc.toLowerCase().includes(search))
                    );

                    // Sort: Pending first, then by date. Completed last.
                    items.sort((a, b) => {
                        if (a.status !== b.status) {
                            return a.status === 'completed' ? 1 : -1;
                        }
                        return new Date(a.date) - new Date(b.date);
                    });

                    items.forEach(r => {
                        const isCompleted = r.status === 'completed';
                        const isUrgent = app.utils.isUrgent(r.date) && !isCompleted;

                        const div = document.createElement('div');
                        let classes = 'bg-slate-800 p-4 rounded-xl border shadow-lg flex flex-col gap-2 relative transition-all mb-3 ';
                        
                        if (isCompleted) {
                            classes += 'border-slate-700 completed-task';
                        } else if (isUrgent) {
                            classes += 'border-red-500 bg-red-900/10 shadow-red-900/10';
                        } else {
                            classes += 'border-slate-700';
                        }
                        
                        div.className = classes;
                        
                        const typeIcons = { business: 'briefcase', meeting: 'handshake', call: 'phone', other: 'note-sticky' };
                        const icon = typeIcons[r.type] || 'circle';
                        const iconColor = isUrgent ? 'text-red-400' : 'text-slate-400';
                        const iconBg = isUrgent ? 'bg-red-900/30' : 'bg-slate-700';

                        div.innerHTML = `
                            <div class="flex justify-between items-start" onclick="app.modals.openReminder(${r.id})">
                                <div class="flex items-start gap-4">
                                    <div class="mt-1 w-10 h-10 rounded-full ${iconBg} flex items-center justify-center ${iconColor} shrink-0">
                                        <i class="fa-solid fa-${icon} text-sm"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-white text-base leading-snug mb-1 ${isUrgent ? 'text-red-400' : ''}">
                                            ${isUrgent ? '<span class="bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded mr-1 align-middle">ç´§æ€¥</span>' : ''}
                                            ${r.desc}
                                        </h4>
                                        <p class="text-slate-400 text-sm font-medium">${r.date || 'æ— æ—¥æœŸ'}</p>
                                    </div>
                                </div>
                                <div class="flex flex-col items-end gap-3 shrink-0">
                                    ${r.amount > 0 ? `<div class="text-right"><span class="block font-bold text-amber-400 text-base">Â¥${app.utils.formatNumberCompact(r.amount)}</span></div>` : ''}
                                    <div class="flex items-center gap-3">
                                        <button onclick="event.stopPropagation(); window.toggleReminderStatus(${r.id})" class="${isCompleted ? 'text-green-500' : 'text-slate-600 hover:text-green-400'} p-2 -mr-1 active:scale-110 transition-transform">
                                            <i class="fa-solid ${isCompleted ? 'fa-circle-check' : 'fa-circle'} text-xl"></i>
                                        </button>
                                        <button onclick="event.stopPropagation(); window.deleteReminder(${r.id})" class="text-slate-600 hover:text-red-400 p-2 -mr-2 active:scale-110 transition-transform">
                                            <i class="fa-solid fa-trash-can text-xl"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            ${!isCompleted ? `
                            <div class="border-t border-slate-700/50 pt-3 mt-1 flex justify-end">
                                <button onclick="app.utils.addToCalendar('${r.desc}', '${r.date}')" class="text-xs text-blue-400 flex items-center gap-1 px-3 py-1.5 bg-slate-700/50 rounded-lg hover:bg-slate-700 transition-colors">
                                    <i class="fa-regular fa-calendar-plus"></i> åŠ å…¥æ—¥å†
                                </button>
                            </div>` : ''}
                        `;
                        list.appendChild(div);
                    });
                    if (items.length === 0) list.innerHTML = `<div class="text-center text-slate-500 py-10 text-sm">æš‚æ— æé†’</div>`;
                }
            },

            settings: {
                save() {
                    const apiKey = document.getElementById('setting-api-key').value.trim();
                    app.state.settings = { apiKey };
                    localStorage.setItem('bank_settings', JSON.stringify(app.state.settings));
                    app.utils.toast('è®¾ç½®å·²ä¿å­˜');
                }
            },

            speech: {
                recognition: null,
                startRec() {
                    const btn = document.getElementById('btn-mic');
                    const status = document.getElementById('mic-status');
                    btn.classList.add('bg-red-500/20', 'border-red-500', 'text-red-500');
                    status.innerText = "æ­£åœ¨è†å¬...";
                    
                    if ('webkitSpeechRecognition' in window) {
                        this.recognition = new webkitSpeechRecognition();
                        this.recognition.lang = 'zh-CN';
                        this.recognition.continuous = false;
                        this.recognition.interimResults = false;
                        
                        this.recognition.onresult = (event) => {
                            const text = event.results[0][0].transcript;
                            const input = document.getElementById('ai-input-text');
                            input.value += (input.value ? ' ' : '') + text;
                        };
                        
                        this.recognition.onerror = (e) => {
                            console.error(e);
                            app.utils.toast('è¯­éŸ³è¯†åˆ«é”™è¯¯', 'error');
                            this.stopRec();
                        };
                        
                        this.recognition.onend = () => {
                            this.stopRec();
                        }

                        this.recognition.start();
                    } else {
                        app.utils.toast('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«', 'error');
                        this.stopRec();
                    }
                },
                stopRec() {
                    const btn = document.getElementById('btn-mic');
                    const status = document.getElementById('mic-status');
                    btn.classList.remove('bg-red-500/20', 'border-red-500', 'text-red-500');
                    status.innerText = "æŒ‰ä½è¯´è¯";
                    if (this.recognition) {
                        this.recognition.stop();
                    }
                },
                start() {
                    // Quick access from dashboard
                    app.modals.open('ai');
                    // setTimeout(() => this.startRec(), 500); // Optional: auto start
                }
            },

            ai: {
                async process() {
                    const text = document.getElementById('ai-input-text').value;
                    if (!text) return app.utils.toast('è¯·è¾“å…¥å†…å®¹', 'error');

                    const btn = document.getElementById('btn-ai-send');
                    const originalBtnContent = btn.innerHTML;
                    btn.disabled = true;
                    btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> å¤„ç†ä¸­...`;

                    const API_URL = "https://api.deepseek.com/chat/completions";
                    const { apiKey } = app.state.settings;
                    
                    // Construct System Prompt
                    const systemPrompt = `You are a CRM Data Extraction Assistant. 
                    Extract entities from the user's text into a JSON object.
                    
                    Supported Intents: 
                    1. 'add_client'
                    2. 'add_reminder'
                    3. 'delete_client'
                    4. 'delete_reminder'
                    
                    Output Format (JSON Only):
                    {
                        "intent": "add_client" | "add_reminder" | "delete_client" | "delete_reminder",
                        "name": string (Client Name, for add/delete),
                        "company": string,
                        "role": string,
                        "id_card": string,
                        "assets": number,
                        "hobbies": string,
                        "remarks": string,
                        "desc": string (For reminder description or keyword to delete),
                        "date": string (YYYY-MM-DD),
                        "amount": number,
                        "type": "business"|"meeting"|"call"|"other"
                    }
                    
                    Current Date: ${new Date().toISOString().split('T')[0]}.
                    If date is 'tomorrow', calculate it.
                    Return ONLY raw JSON. No markdown block.`;

                    if (!apiKey) {
                        btn.disabled = false;
                        btn.innerHTML = originalBtnContent;
                        return app.utils.toast('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API Key', 'error');
                    }

                    const payload = {
                        model: "deepseek-chat",
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: text }
                        ],
                        response_format: {
                            type: "json_object"
                        },
                        stream: false
                    };

                    try {
                        const response = await fetch(API_URL, {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey}`
                            },
                            body: JSON.stringify(payload)
                        });

                        const data = await response.json();
                        
                        if (data.error) throw new Error(data.error.message);

                        let resultText = '';
                        if (data.choices && data.choices[0].message) {
                            resultText = data.choices[0].message.content;
                        } else {
                            throw new Error("Invalid API Response");
                        }

                        // Parse JSON (handle potential markdown blocks if API ignores json_object rule, though unlikely with deepseek-chat)
                        const jsonMatch = resultText.match(/\{[\s\S]*\}/);
                        if (!jsonMatch) throw new Error("AI output not valid JSON");
                        
                        const extractedData = JSON.parse(jsonMatch[0]);
                        
                        if (extractedData.intent === 'add_client') {
                            app.data.addClient(extractedData);
                            app.utils.toast(`AI: å·²æ·»åŠ å®¢æˆ· ${extractedData.name}`);
                        } else if (extractedData.intent === 'add_reminder') {
                            if(!extractedData.date) extractedData.date = new Date().toISOString().split('T')[0];
                            extractedData.status = 'pending'; // Force pending for AI additions
                            app.data.addReminder(extractedData);
                            app.utils.toast(`AI: å·²æ·»åŠ æé†’äº‹é¡¹`);
                        } else if (extractedData.intent === 'delete_client') {
                            const target = app.state.clients.find(c => c.name.includes(extractedData.name));
                            if (target) {
                                app.data.deleteClient(target.id);
                                app.utils.toast(`AI: å·²åˆ é™¤å®¢æˆ· ${target.name}`, 'error');
                            } else {
                                app.utils.toast(`AI: æœªæ‰¾åˆ°å®¢æˆ· ${extractedData.name}`, 'error');
                            }
                        } else if (extractedData.intent === 'delete_reminder') {
                            const target = app.state.reminders.find(r => r.desc.includes(extractedData.desc));
                            if (target) {
                                app.data.deleteReminder(target.id);
                                app.utils.toast(`AI: å·²åˆ é™¤æé†’äº‹é¡¹`, 'error');
                            } else {
                                app.utils.toast(`AI: æœªæ‰¾åˆ°ç›¸å…³æé†’`, 'error');
                            }
                        } else {
                            app.utils.toast('æ— æ³•è¯†åˆ«æ„å›¾', 'error');
                        }

                        document.getElementById('ai-input-text').value = '';
                        app.modals.close('ai');

                    } catch (error) {
                        console.error(error);
                        app.utils.toast('AI è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
                    } finally {
                        btn.disabled = false;
                        btn.innerHTML = originalBtnContent;
                    }
                }
            },

            utils: {
                toast(msg, type = 'success') {
                    const toast = document.getElementById('toast');
                    const icon = document.getElementById('toast-icon');
                    const text = document.getElementById('toast-message');
                    
                    text.innerText = msg;
                    if (type === 'error') {
                        icon.className = 'fa-solid fa-circle-exclamation text-red-400 text-lg';
                    } else {
                        icon.className = 'fa-solid fa-circle-check text-green-400 text-lg';
                    }

                    toast.classList.remove('opacity-0', 'translate-y-[-20px]');
                    setTimeout(() => {
                        toast.classList.add('opacity-0', 'translate-y-[-20px]');
                    }, 3000);
                },
                formatCurrency(num) {
                    if (!num) return 'Â¥0';
                    if (num >= 100000000) return 'Â¥' + (num / 100000000).toFixed(1) + 'äº¿';
                    if (num >= 10000) return 'Â¥' + (num / 10000).toFixed(1) + 'ä¸‡';
                    return 'Â¥' + num.toLocaleString();
                },
                formatNumberCompact(num) {
                    if (!num) return '0';
                    if (num >= 100000000) return (num / 100000000).toFixed(1) + 'äº¿';
                    if (num >= 10000) return (num / 10000).toFixed(1) + 'ä¸‡';
                    return num.toLocaleString();
                },
                isUrgent(dateStr) {
                    if (!dateStr) return false;
                    const today = new Date();
                    today.setHours(0,0,0,0);
                    const target = new Date(dateStr);
                    target.setHours(0,0,0,0);
                    // Difference in milliseconds
                    const diffTime = target - today;
                    // Difference in days (ceil to handle partial days)
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    return diffDays <= 2; // urgent if due within 2 days (or overdue)
                },
                checkUrgentAlert() {
                    const urgentTasks = app.state.reminders.filter(r => 
                        r.status !== 'completed' && app.utils.isUrgent(r.date)
                    );

                    if (urgentTasks.length > 0) {
                        const container = document.getElementById('urgent-list-container');
                        container.innerHTML = '';
                        urgentTasks.forEach(t => {
                            const div = document.createElement('div');
                            div.className = "bg-slate-700/50 p-3 rounded-xl border border-red-500/20";
                            div.innerHTML = `
                                <div class="flex justify-between items-start">
                                    <h4 class="text-white text-sm font-bold">${t.desc}</h4>
                                    <span class="text-red-400 text-xs font-bold">${t.date}</span>
                                </div>
                                ${t.amount > 0 ? `<p class="text-amber-400 text-xs mt-1">Â¥${app.utils.formatNumberCompact(t.amount)}</p>` : ''}
                            `;
                            container.appendChild(div);
                        });
                        document.getElementById('modal-urgent').classList.remove('hidden');
                    }
                },
                addToCalendar(title, dateStr) {
                    if (!dateStr) return app.utils.toast('æ— æ—¥æœŸï¼Œæ— æ³•æ·»åŠ åˆ°æ—¥å†', 'error');

                    // 1. Toast Feedback
                    app.utils.toast("æ­£åœ¨è°ƒèµ·æ—¥å†... å¦‚æ— ååº”ï¼Œè¯·å°è¯•ä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦æµè§ˆå™¨æ‰“å¼€ã€‚");

                    // 2. Generate ICS Content
                    const date = dateStr.replace(/-/g, '');
                    const icsContent = [
                        'BEGIN:VCALENDAR',
                        'VERSION:2.0',
                        'BEGIN:VEVENT',
                        `DTSTART;VALUE=DATE:${date}`,
                        `DTEND;VALUE=DATE:${date}`,
                        `SUMMARY:${title}`,
                        'END:VEVENT',
                        'END:VCALENDAR'
                    ].join('\n');

                    // 3. Create Data URI
                    const uri = "data:text/calendar;charset=utf8," + encodeURIComponent(icsContent);

                    // 4. Execution (Open vs Location)
                    const newWindow = window.open(uri);
                    if (!newWindow) {
                        window.location.href = uri;
                    }
                }
            }
        };

        // Global Handlers attached to window
        window.deleteClient = function(id) {
            if(confirm('ç¡®å®šåˆ é™¤è¯¥å®¢æˆ·å—ï¼Ÿ')) {
                 app.data.deleteClient(id);
                 app.utils.toast('å®¢æˆ·å·²åˆ é™¤', 'error');
            }
        };

        window.deleteReminder = function(id) {
            if(confirm('ç¡®å®šåˆ é™¤è¯¥æé†’å—ï¼Ÿ')) {
                 app.data.deleteReminder(id);
                 app.utils.toast('æé†’å·²åˆ é™¤', 'error');
            }
        };

        window.toggleReminderStatus = function(id) {
            app.data.toggleReminderStatus(id);
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });

    </script>
</body>
</html>